<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="group">

	<select id="selectMyList" parameterType="string"
		resultType="GroupMylistDto">
		SELECT SGROUP_ID, SGROUP_NAME, SGROUP_IMG_PATH,
		SGROUP_IMG_NAME FROM SGROUP
		WHERE SGROUP_ID IN
		(SELECT SGROUP_ID
		FROM
		SGROUP_MEMBER
		WHERE
		SGROUP_MEM_ID = #{memberId})
	</select>

	<select id="selectMyCount" parameterType="string"
		resultType="_int">
		SELECT COUNT(*) FROM SGROUP_MEMBER
		WHERE SGROUP_MEM_ID =
		#{memberId}
	</select>

	<select id="selectAllOpenList" parameterType="map"
		resultType="GroupDto">
		SELECT S.SGROUP_ID, S.SGROUP_NAME, S.SGROUP_OPEN,
		S.SGROUP_PWD, S.SGROUP_EXPLAIN, S.SGROUP_IMG_PATH, S.SGROUP_IMG_NAME
		FROM (SELECT ROWNUM, SGROUP.* FROM SGROUP WHERE
		SGROUP_OPEN = '0')
		S
		WHERE ROWNUM BETWEEN #{startRounum} AND #{endRounum}
	</select>

	<select id="selectRandList" resultType="GroupDto">
		SELECT * FROM (
		SELECT
		* FROM SGROUP ORDER BY DBMS_RANDOM.RANDOM
		)
		WHERE
		ROWNUM <![CDATA[<=]]>
		20
	</select>

	<select id="selectFindList" parameterType="string"
		resultType="GroupDto">
		SELECT * FROM SGROUP WHERE SGROUP_NAME LIKE '%${findName}%'
	</select>

	<select id="selectAllList" resultType="GroupDto">
		SELECT * FROM SGROUP
	</select>

	<insert id="insert" parameterType="GroupCreateDto">
		INSERT ALL
		INTO SGROUP VALUES
		(SEQ_SGROUP_ID.nextval, #{sgroupName},
		#{sgroupOpen},#{sgroupPwd},#{sgroupEx},#{sgroupImgPath},#{sgroupImgName})
		INTO SGROUP_MEMBER VALUES (SEQ_SGROUP_ID.nextval, #{sgroupWriter})
		SELECT *
		FROM DUAL
	</insert>

	<select id="selectGroupInfoList" parameterType="_int"
		resultType="GroupInfoListDto">
		SELECT * FROM SGROUP
		JOIN SGROUP_MEMBER USING (SGROUP_ID)
		WHERE SGROUP_ID = ${groupId}
	</select>

	<select id="selectGroupInfoOne" parameterType="_int"
		resultType="GroupDto">
		SELECT * FROM SGROUP
		WHERE SGROUP_ID = ${groupId}
	</select>

	<resultMap id="recordSumResultMap" type="GroupRecordSumDto">
		<result property="memId" column="MEM_ID" />
		<result property="sumMin" column="SUM_MIN" />
	</resultMap>

	<select id="selectGroupRecordSumList" parameterType="_int"
		resultMap="recordSumResultMap">
		SELECT
		S.SGROUP_MEM_ID AS "MEM_ID",
		NVL( SUBSTR( TO_CHAR(NUMTODSINTERVAL( SUM(R.RECORD_END -
		R.RECORD_START),'DAY'), 'HH24:MI:SS'), 10, 10), '0')AS "SUM_MIN"
		FROM
		SGROUP_MEMBER S
		LEFT JOIN (SELECT * FROM RECORD WHERE RECORD_START >= ( SYSDATE - 7 ) ) R
		ON (S.SGROUP_MEM_ID = R.RECORD_MEM_ID)
		WHERE SGROUP_ID = #{groupId}
		GROUP BY S.SGROUP_MEM_ID
	</select>

	<!-- <select id="test" parameterType="string" resultType="_int"> SELECT 
		ROUND(SUM(TO_NUMBER(TO_CHAR(RECORD_END, 'HH24MISS')) - TO_NUMBER(TO_CHAR(RECORD_START, 
		'HH24MISS'))) / 100) FROM RECORD WHERE RECORD_START >= ( SYSDATE - 7 ) AND 
		RECORD_MEM_ID = #{memId} </select> -->

	<update id="update" parameterType="GroupUpdateDto">
		UPDATE SGROUP SET SGROUP_NAME
		= #{sgroupName}, SGROUP_OPEN = #{sgroupOpen}, SGROUP_PWD =
		#{sgroupPwd},
		SGROUP_EXPLAIN = #{sgroupEx}, SGROUP_IMG_PATH =
		#{sgroupImgPath}, SGROUP_IMG_NAME= #{sgroupImgName}
		WHERE SGROUP_ID =
		#{sgroupId}
	</update>

	<update id="updateMin" parameterType="GroupUpdateMinDto">
		UPDATE SGROUP SET
		SGROUP_NAME = #{sgroupName}, SGROUP_OPEN = #{sgroupOpen}, SGROUP_PWD =
		#{sgroupPwd},
		SGROUP_EXPLAIN = #{sgroupEx}
		WHERE SGROUP_ID = #{sgroupId}
	</update>

	<select id="selectGroupRecordDaySumList"  parameterType="_int"  resultType="GroupRecordDaySumDto">
		SELECT '그룹원' MEM_ID, 
		TO_CHAR(SYSDATE - 7, 'DY') D1, TO_CHAR(SYSDATE - 6, 'DY') D2, TO_CHAR(SYSDATE - 5, 'DY') D3, TO_CHAR(SYSDATE - 4, 'DY') D4
		, TO_CHAR(SYSDATE - 3, 'DY') D5, TO_CHAR(SYSDATE - 2, 'DY') D6, TO_CHAR(SYSDATE - 1, 'DY') D7
		FROM DUAL
		UNION
		SELECT A.SGROUP_MEM_ID "MEM_ID"
		, NVL( SUBSTR((SELECT
		SUBSTR(TO_CHAR(NUMTODSINTERVAL( SUM(R.RECORD_END - R.RECORD_START) ,'DAY'), 'HH24:MI:SS'), 12, 9)
		FROM SGROUP_MEMBER S
		JOIN RECORD R ON (S.SGROUP_MEM_ID = R.RECORD_MEM_ID)
		WHERE R.RECORD_START BETWEEN SYSDATE - 8 AND SYSDATE - 7
		AND S.SGROUP_MEM_ID = A.SGROUP_MEM_ID), 12, 8), '0')
		AS "D1"
		, NVL( SUBSTR((SELECT
		TO_CHAR(NUMTODSINTERVAL( SUM(R.RECORD_END - R.RECORD_START) ,'DAY'), 'HH24:MI:SS')
		FROM SGROUP_MEMBER S
		JOIN RECORD R ON (S.SGROUP_MEM_ID = R.RECORD_MEM_ID)
		WHERE R.RECORD_START BETWEEN SYSDATE - 7 AND SYSDATE - 6
		AND S.SGROUP_MEM_ID = A.SGROUP_MEM_ID), 12, 8), '0')
		AS "D2"
		, NVL( SUBSTR((SELECT
		TO_CHAR(NUMTODSINTERVAL( SUM(R.RECORD_END - R.RECORD_START),'DAY'), 'HH24:MI:SS')
		FROM SGROUP_MEMBER S
		JOIN RECORD R ON (S.SGROUP_MEM_ID = R.RECORD_MEM_ID)
		WHERE R.RECORD_START BETWEEN SYSDATE - 6 AND SYSDATE - 5
		AND S.SGROUP_MEM_ID = A.SGROUP_MEM_ID), 12, 8), '0')
		AS "D3"
		, NVL( SUBSTR((SELECT
		TO_CHAR(NUMTODSINTERVAL( SUM(R.RECORD_END - R.RECORD_START),'DAY'), 'HH24:MI:SS')
		FROM SGROUP_MEMBER S
		JOIN RECORD R ON (S.SGROUP_MEM_ID = R.RECORD_MEM_ID)
		WHERE R.RECORD_START BETWEEN SYSDATE - 5 AND SYSDATE - 4
		AND S.SGROUP_MEM_ID = A.SGROUP_MEM_ID), 12, 8), '0')
		AS "D4"
		, NVL( SUBSTR((SELECT
		TO_CHAR(NUMTODSINTERVAL( SUM(R.RECORD_END - R.RECORD_START) ,'DAY'), 'HH24:MI:SS')
		FROM SGROUP_MEMBER S
		JOIN RECORD R ON (S.SGROUP_MEM_ID = R.RECORD_MEM_ID)
		WHERE R.RECORD_START BETWEEN SYSDATE - 4 AND SYSDATE - 3
		AND S.SGROUP_MEM_ID = A.SGROUP_MEM_ID), 12, 8), '0')
		AS "D5"
		, NVL( SUBSTR((SELECT
		TO_CHAR(NUMTODSINTERVAL( SUM(R.RECORD_END - R.RECORD_START) ,'DAY'), 'HH24:MI:SS')
		FROM SGROUP_MEMBER S
		JOIN RECORD R ON (S.SGROUP_MEM_ID = R.RECORD_MEM_ID)
		WHERE R.RECORD_START BETWEEN SYSDATE - 3 AND SYSDATE - 2
		AND S.SGROUP_MEM_ID = A.SGROUP_MEM_ID), 12, 8), '0')
		AS "D6"
		, NVL( SUBSTR((SELECT
		TO_CHAR( NUMTODSINTERVAL( SUM(R.RECORD_END - R.RECORD_START) ,'DAY'),
		'HH24:MI:SS')
		FROM SGROUP_MEMBER S
		JOIN RECORD R ON (S.SGROUP_MEM_ID = R.RECORD_MEM_ID)
		WHERE R.RECORD_START BETWEEN SYSDATE - 2 AND SYSDATE - 1
		AND S.SGROUP_MEM_ID = A.SGROUP_MEM_ID), 12, 8), '0')
		AS "D7"
		FROM SGROUP_MEMBER A
		WHERE A.SGROUP_ID = #{groupId}
		GROUP BY A.SGROUP_MEM_ID
	</select>
</mapper>
